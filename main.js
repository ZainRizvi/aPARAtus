"use strict";var S=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var X=(n,s)=>{for(var e in s)S(n,e,{get:s[e],enumerable:!0})},q=(n,s,e,r)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of W(s))!G.call(n,t)&&t!==e&&S(n,t,{get:()=>s[t],enumerable:!(r=U(s,t))||r.enumerable});return n};var K=n=>q(S({},"__esModule",{value:!0}),n);var Z={};X(Z,{default:()=>x});module.exports=K(Z);var h=require("obsidian");var p=require("obsidian");function C(n,s){let e=m(n),r=m(s);return!!(e===r||r.startsWith(e+"/")||e.startsWith(r+"/"))}function N(n){for(let s=0;s<n.length;s++)for(let e=s+1;e<n.length;e++)if(C(n[s],n[e])){let r=m(n[s]),t=m(n[e]);return`PARA folders cannot be nested: "${r}" and "${t}"`}return null}function m(n){return n.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function J(n){let s=m(n),e=s.lastIndexOf("/");return e===-1?"":s.substring(0,e)}function F(n,s){let e=m(n),r=m(s);return J(e)===r}function T(n){let s=m(n),e=s.lastIndexOf("/");return e===-1?s:s.substring(e+1)}function j(n,s,e){let r=m(n),t=`${r}/${s}`;if(!e.has(t))return t;let o=new Date().toISOString().split("T")[0],c=`${r}/${s} (Archived ${o})`;if(!e.has(c))return c;let i=2;for(;;){let d=`${r}/${s} (Archived ${o}) (${i})`;if(!e.has(d))return d;if(i++,i>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var L=class extends p.AbstractInputSuggest{constructor(s,e){super(s,e),this.textInputEl=e}getSuggestions(s){let e=this.app.vault.getAllLoadedFiles().filter(t=>t instanceof p.TFolder);if(!s)return e;let r=s.toLowerCase();return e.filter(t=>t.path.toLowerCase().includes(r))}renderSuggestion(s,e){e.setText(s.path)}selectSuggestion(s){this.textInputEl.value=s.path,this.textInputEl.dispatchEvent(new Event("input",{bubbles:!0})),this.close()}},u={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1,projectFolderFormat:"YYYY-MM-DD {{name}}"},R={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},B={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function Q(n,s,e){let t=["projectsPath","areasPath","resourcesPath","archivePath"].filter(a=>a!==s);for(let a of t){let o=e[a],c=R[a],i=R[s];if(n===o)return`${i} folder cannot be the same as ${c} folder`;if(C(n,o))return`${i} folder cannot be nested with ${c} folder`}return null}var I="para-manager-invalid-input",$="para-manager-warning-input";function w(n,s,e,r){let t=s.inputEl;new L(r.app,t);let a=document.createElement("div");a.style.marginTop="-8px",a.style.marginBottom="16px",a.style.fontSize="var(--font-ui-smaller)",a.style.color="var(--color-yellow)",a.style.display="none",n.settingEl.insertAdjacentElement("afterend",a);let o=c=>{r.app.vault.getAbstractFileByPath(c)?(t.classList.remove($),t.style.borderColor="",t.style.backgroundColor="",a.style.display="none"):(t.classList.add($),t.style.borderColor="var(--color-yellow)",t.style.backgroundColor="rgba(var(--color-yellow-rgb), 0.1)",a.textContent=`Folder "${c}" does not exist (will be created automatically)`,a.style.display="block")};s.setPlaceholder(B[e]).setValue(r.settings[e]),setTimeout(()=>o(r.settings[e]),0),t.addEventListener("blur",async()=>{let i=s.getValue().trim().replace(/\/+$/,"")||B[e],d=Q(i,e,r.settings);d?(t.classList.add(I),t.classList.remove($),t.style.borderColor="var(--text-error)",t.style.backgroundColor="rgba(var(--color-red-rgb), 0.1)",a.textContent=d,a.style.color="var(--text-error)",a.style.display="block",s.setValue(r.settings[e]),setTimeout(()=>{t.classList.remove(I),t.style.borderColor="",t.style.backgroundColor="",a.style.color="var(--color-yellow)",o(r.settings[e])},100)):(t.classList.remove(I),o(i),r.settings[e]=i,await r.saveSettings())})}var y=class extends p.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty();let e=new p.Setting(s).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)");e.addText(l=>w(e,l,"projectsPath",this.plugin));let r=new p.Setting(s).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)");r.addText(l=>w(r,l,"areasPath",this.plugin));let t=new p.Setting(s).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)");t.addText(l=>w(t,l,"resourcesPath",this.plugin));let a=new p.Setting(s).setName("Archive folder").setDesc("Path where archived items will be moved");a.addText(l=>w(a,l,"archivePath",this.plugin));let o=new p.Setting(s).setName("Project folder format"),c=document.createDocumentFragment();c.appendText("Use {{name}} for project name. Supports ");let i=document.createElement("a");i.href="https://momentjs.com/docs/#/displaying/format/",i.textContent="Moment.js tokens",i.setAttr("target","_blank"),c.appendChild(i),c.appendText(": YYYY, MM, DD, etc."),o.setDesc(c);let d=document.createElement("div");d.style.marginTop="-8px",d.style.marginBottom="16px",d.style.fontSize="var(--font-ui-smaller)",d.style.color="var(--text-muted)",o.addText(l=>{let g=l.inputEl,A=f=>{let M=f.includes("{{name}}");if(M){let O="My Project",V=window.moment(),Y=f.replace(/\{\{name\}\}/g,`[${O}]`),H=V.format(Y);d.textContent=`Preview: ${H}`,d.style.color="var(--text-muted)",g.style.borderColor=""}else d.textContent="Format must contain {{name}}",d.style.color="var(--text-error)",g.style.borderColor="var(--text-error)";return M};l.setPlaceholder("YYYY-MM-DD {{name}}").setValue(this.plugin.settings.projectFolderFormat),A(this.plugin.settings.projectFolderFormat),g.addEventListener("input",()=>{let f=l.getValue().trim()||u.projectFolderFormat;A(f)}),g.addEventListener("blur",async()=>{let f=l.getValue().trim()||u.projectFolderFormat;A(f)?(this.plugin.settings.projectFolderFormat=f,await this.plugin.saveSettings()):(l.setValue(this.plugin.settings.projectFolderFormat),A(this.plugin.settings.projectFolderFormat))})}),o.settingEl.insertAdjacentElement("afterend",d),new p.Setting(s).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(l=>l.setValue(this.plugin.settings.focusAfterArchive).onChange(async g=>{this.plugin.settings.focusAfterArchive=g,await this.plugin.saveSettings()})),new p.Setting(s).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(l=>l.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async g=>{this.plugin.settings.confirmBeforeArchive=g,await this.plugin.saveSettings()}))}};var k=require("obsidian"),b=class extends k.Modal{constructor(e,r,t,a,o){super(e);this.confirmed=!1;this.itemName=r,this.destPath=t,this.onConfirm=a,this.onCancel=o}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let a=r.createEl("button",{text:"Archive",cls:"mod-cta"});a.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),a.focus(),this.keydownHandler=o=>{o.key==="Enter"&&!o.isComposing?(o.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):o.key==="Escape"&&(o.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},P=class extends k.Modal{constructor(s,e,r,t){super(s),this.title=e,this.placeholder=r,this.onSubmit=t}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:this.title});let e=s.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.style.marginBottom="1em",e.focus();let r=s.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),r.createEl("button",{text:"Create",cls:"mod-cta"}).addEventListener("click",()=>{let o=e.value.trim();o&&(this.onSubmit(o),this.close())}),e.addEventListener("keydown",o=>{if(o.key==="Enter"&&!o.isComposing){o.preventDefault();let c=e.value.trim();c&&(this.onSubmit(c),this.close())}else o.key==="Escape"&&(o.preventDefault(),this.close())})}onClose(){let{contentEl:s}=this;s.empty()}};var v=require("obsidian");async function E(n,s){let e=(0,v.normalizePath)(s),r=n.vault.getAbstractFileByPath(e);if(r){if(!(r instanceof v.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let t=e.split("/").filter(Boolean);for(let a=1;a<=t.length;a++){let o=t.slice(0,a).join("/"),c=n.vault.getAbstractFileByPath(o);if(!c)await n.vault.createFolder(o);else if(!(c instanceof v.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${o}" exists but is not a folder`)}}function D(n,s){let e=new Set,r=n.vault.getAbstractFileByPath(s);if(r instanceof v.TFolder)for(let t of r.children)e.add((0,v.normalizePath)(t.path));return e}async function z(n,s){let e=(0,v.normalizePath)(s),r=n.vault.getAbstractFileByPath(e);if(r)try{let t=n.workspace.getLeavesOfType("file-explorer")[0];if(!t)return;let a=t.view;typeof a.revealInFolder=="function"&&a.revealInFolder(r)}catch(t){console.debug("PARA Manager: Could not focus folder",t)}}var _=3,x=class extends h.Plugin{constructor(){super(...arguments);this.settings=u;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new y(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let r=this.app.workspace.getActiveFile();if(!r)return!1;let t=this.findTopLevelItem(r);return t?(e||this.archiveItem(t),!0):!1}}),this.addCommand({id:"create-project",name:"Create Project",callback:()=>{new P(this.app,"Create Project","Project name",e=>this.createParaItem(e,"projectsPath","Project")).open()}}),this.addCommand({id:"create-area",name:"Create Area",callback:()=>{new P(this.app,"Create Area","Area name",e=>this.createParaItem(e,"areasPath","Area")).open()}}),this.addCommand({id:"create-resource",name:"Create Resource",callback:()=>{new P(this.app,"Create Resource","Resource name",e=>this.createParaItem(e,"resourcesPath","Resource")).open()}}),this.registerEvent(this.app.workspace.on("file-menu",(e,r)=>{!(r instanceof h.TFolder)&&!(r instanceof h.TFile)||!this.getSourceFolders().some(o=>F(r.path,o))||e.addItem(o=>{o.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(r)})})}))}async loadSettings(){this.settings=Object.assign({},u,await this.loadData());let e=this.getSourceFolders(),r=(0,h.normalizePath)(this.settings.archivePath);if(e.includes(r)){new h.Notice("PARA Manager: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,this.settings.archivePath=u.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new h.Notice("PARA Manager: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,await this.saveSettings();return}let a=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],o=N(a);o&&(new h.Notice(`PARA Manager: Invalid settings detected (${o}), resetting to defaults`),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,this.settings.archivePath=u.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}formatProjectName(e,r){let t=window.moment(),a=r.replace(/\{\{name\}\}/g,`[${e}]`);return t.format(a)}async createParaItem(e,r,t){let a=this.settings[r],o=e;r==="projectsPath"&&(o=this.formatProjectName(e,this.settings.projectFolderFormat));let c=(0,h.normalizePath)(`${a}/${o}`);if(this.app.vault.getAbstractFileByPath(c)){new h.Notice(`${t} "${e}" already exists`);return}try{await E(this.app,a),await this.app.vault.createFolder(c);let i=(0,h.normalizePath)(`${c}/index.md`),d=`# ${e}
`,l=await this.app.vault.create(i,d);await this.app.workspace.getLeaf().openFile(l),new h.Notice(`Created ${t.toLowerCase()} "${e}"`)}catch(i){let d=i instanceof Error?i.message:"Unknown error";new h.Notice(`Failed to create ${t.toLowerCase()}: ${d}`),console.error(`PARA Manager: Failed to create ${t}`,i)}}getSourceFolders(){return[(0,h.normalizePath)(this.settings.projectsPath),(0,h.normalizePath)(this.settings.areasPath),(0,h.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let r=this.getSourceFolders();if(r.some(a=>F(e.path,a)))return e;let t=e.parent;for(;t;){if(r.some(a=>F(t.path,a)))return t;t=t.parent}return null}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let r=(0,h.normalizePath)(this.settings.archivePath),t=T(e.path);try{let o=this.getSourceFolders().find(g=>F(e.path,g)),c=o?T(o):"";await E(this.app,r);let i=c?(0,h.normalizePath)(`${r}/${c}`):r;await E(this.app,i);let d=D(this.app,i),l=j(i,t,d);if(this.settings.confirmBeforeArchive)return new Promise(g=>{new b(this.app,t,l,async()=>{await this.performArchive(e,l,t,i,o),g()},()=>g()).open()});await this.performArchive(e,l,t,i,o)}catch(a){let o=a instanceof Error?a.message:"Unknown error";new h.Notice(`Failed to archive "${t}": ${o}`),console.error("PARA Manager: Failed to archive item",a)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,r,t,a,o){let c=r;for(let i=0;i<_;i++)try{await this.app.vault.rename(e,r);break}catch(d){if(i===_-1)throw d;let l=D(this.app,a);l.add(r),r=j(a,t,l)}r!==c?new h.Notice(`Archived "${t}" to ${r} (path changed due to conflict)`):new h.Notice(`Archived "${t}" to ${r}`),this.settings.focusAfterArchive&&o&&await z(this.app,o)}};
