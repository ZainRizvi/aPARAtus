"use strict";var w=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var V=(o,r)=>{for(var e in r)w(o,e,{get:r[e],enumerable:!0})},$=(o,r,e,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of T(r))!I.call(o,t)&&t!==e&&w(o,t,{get:()=>r[t],enumerable:!(s=E(r,t))||s.enumerable});return o};var C=o=>$(w({},"__esModule",{value:!0}),o);var D={};V(D,{default:()=>A});module.exports=C(D);var c=require("obsidian");var n=require("obsidian");function l(o,r){let e=d(o),s=d(r);return!!(e===s||s.startsWith(e+"/")||e.startsWith(s+"/"))}function y(o){for(let r=0;r<o.length;r++)for(let e=r+1;e<o.length;e++)if(l(o[r],o[e])){let s=d(o[r]),t=d(o[e]);return`PARA folders cannot be nested: "${s}" and "${t}"`}return null}function d(o){return o.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function R(o){let r=d(o),e=r.lastIndexOf("/");return e===-1?"":r.substring(0,e)}function v(o,r){let e=d(o),s=d(r);return R(e)===s}function b(o){let r=d(o),e=r.lastIndexOf("/");return e===-1?r:r.substring(e+1)}function j(o,r,e){let s=d(o),t=`${s}/${r}`;if(!e.has(t))return t;let i=new Date().toISOString().split("T")[0],g=`${s}/${r} (Archived ${i})`;if(!e.has(g))return g;let h=2;for(;;){let f=`${s}/${r} (Archived ${i}) (${h})`;if(!e.has(f))return f;if(h++,h>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var u={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1},m=class extends n.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),new n.Setting(r).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)").addText(e=>e.setPlaceholder("Projects").setValue(this.plugin.settings.projectsPath).onChange(async s=>{let t=s.trim().replace(/\/+$/,"")||"Projects";if(t===this.plugin.settings.archivePath){new n.Notice("Projects folder cannot be the same as Archive folder"),e.setValue(this.plugin.settings.projectsPath);return}if(t===this.plugin.settings.areasPath){new n.Notice("Projects folder cannot be the same as Areas folder"),e.setValue(this.plugin.settings.projectsPath);return}if(t===this.plugin.settings.resourcesPath){new n.Notice("Projects folder cannot be the same as Resources folder"),e.setValue(this.plugin.settings.projectsPath);return}if(l(t,this.plugin.settings.archivePath)){new n.Notice("Projects folder cannot be nested with Archive folder"),e.setValue(this.plugin.settings.projectsPath);return}if(l(t,this.plugin.settings.areasPath)){new n.Notice("Projects folder cannot be nested with Areas folder"),e.setValue(this.plugin.settings.projectsPath);return}if(l(t,this.plugin.settings.resourcesPath)){new n.Notice("Projects folder cannot be nested with Resources folder"),e.setValue(this.plugin.settings.projectsPath);return}this.plugin.settings.projectsPath=t,await this.plugin.saveSettings()})),new n.Setting(r).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)").addText(e=>e.setPlaceholder("Areas").setValue(this.plugin.settings.areasPath).onChange(async s=>{let t=s.trim().replace(/\/+$/,"")||"Areas";if(t===this.plugin.settings.archivePath){new n.Notice("Areas folder cannot be the same as Archive folder"),e.setValue(this.plugin.settings.areasPath);return}if(t===this.plugin.settings.projectsPath){new n.Notice("Areas folder cannot be the same as Projects folder"),e.setValue(this.plugin.settings.areasPath);return}if(t===this.plugin.settings.resourcesPath){new n.Notice("Areas folder cannot be the same as Resources folder"),e.setValue(this.plugin.settings.areasPath);return}if(l(t,this.plugin.settings.archivePath)){new n.Notice("Areas folder cannot be nested with Archive folder"),e.setValue(this.plugin.settings.areasPath);return}if(l(t,this.plugin.settings.projectsPath)){new n.Notice("Areas folder cannot be nested with Projects folder"),e.setValue(this.plugin.settings.areasPath);return}if(l(t,this.plugin.settings.resourcesPath)){new n.Notice("Areas folder cannot be nested with Resources folder"),e.setValue(this.plugin.settings.areasPath);return}this.plugin.settings.areasPath=t,await this.plugin.saveSettings()})),new n.Setting(r).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)").addText(e=>e.setPlaceholder("Resources").setValue(this.plugin.settings.resourcesPath).onChange(async s=>{let t=s.trim().replace(/\/+$/,"")||"Resources";if(t===this.plugin.settings.archivePath){new n.Notice("Resources folder cannot be the same as Archive folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(t===this.plugin.settings.projectsPath){new n.Notice("Resources folder cannot be the same as Projects folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(t===this.plugin.settings.areasPath){new n.Notice("Resources folder cannot be the same as Areas folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(l(t,this.plugin.settings.archivePath)){new n.Notice("Resources folder cannot be nested with Archive folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(l(t,this.plugin.settings.projectsPath)){new n.Notice("Resources folder cannot be nested with Projects folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(l(t,this.plugin.settings.areasPath)){new n.Notice("Resources folder cannot be nested with Areas folder"),e.setValue(this.plugin.settings.resourcesPath);return}this.plugin.settings.resourcesPath=t,await this.plugin.saveSettings()})),new n.Setting(r).setName("Archive folder").setDesc("Path where archived items will be moved").addText(e=>e.setPlaceholder("Archive").setValue(this.plugin.settings.archivePath).onChange(async s=>{let t=s.trim().replace(/\/+$/,"")||"Archive";if(t===this.plugin.settings.projectsPath){new n.Notice("Archive folder cannot be the same as Projects folder"),e.setValue(this.plugin.settings.archivePath);return}if(t===this.plugin.settings.areasPath){new n.Notice("Archive folder cannot be the same as Areas folder"),e.setValue(this.plugin.settings.archivePath);return}if(t===this.plugin.settings.resourcesPath){new n.Notice("Archive folder cannot be the same as Resources folder"),e.setValue(this.plugin.settings.archivePath);return}if(l(t,this.plugin.settings.projectsPath)){new n.Notice("Archive folder cannot be nested with Projects folder"),e.setValue(this.plugin.settings.archivePath);return}if(l(t,this.plugin.settings.areasPath)){new n.Notice("Archive folder cannot be nested with Areas folder"),e.setValue(this.plugin.settings.archivePath);return}if(l(t,this.plugin.settings.resourcesPath)){new n.Notice("Archive folder cannot be nested with Resources folder"),e.setValue(this.plugin.settings.archivePath);return}this.plugin.settings.archivePath=t,await this.plugin.saveSettings()})),new n.Setting(r).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(e=>e.setValue(this.plugin.settings.focusAfterArchive).onChange(async s=>{this.plugin.settings.focusAfterArchive=s,await this.plugin.saveSettings()})),new n.Setting(r).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(e=>e.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async s=>{this.plugin.settings.confirmBeforeArchive=s,await this.plugin.saveSettings()}))}};var S=3,F=class extends c.Modal{constructor(e,s,t,a,i){super(e);this.confirmed=!1;this.folderName=s,this.destPath=t,this.onConfirm=a,this.onCancel=i}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Project?"}),e.createEl("p",{text:`Move "${this.folderName}" to:`}),e.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let s=e.createDiv({cls:"modal-button-container"});s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let a=s.createEl("button",{text:"Archive",cls:"mod-cta"});a.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),a.focus(),this.keydownHandler=i=>{i.key==="Enter"&&!i.isComposing?(i.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):i.key==="Escape"&&(i.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},A=class extends c.Plugin{constructor(){super(...arguments);this.settings=u;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new m(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let s=this.app.workspace.getActiveFile();if(!s)return!1;let t=this.findTopLevelItem(s);return t?(e||this.archiveItem(t),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(e,s)=>{!(s instanceof c.TFolder)&&!(s instanceof c.TFile)||!this.getSourceFolders().some(i=>v(s.path,i))||e.addItem(i=>{i.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(s)})})}))}async loadSettings(){this.settings=Object.assign({},u,await this.loadData());let e=this.getSourceFolders(),s=(0,c.normalizePath)(this.settings.archivePath);if(e.includes(s)){new c.Notice("Archive Project: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,this.settings.archivePath=u.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new c.Notice("Archive Project: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,await this.saveSettings();return}let a=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],i=y(a);i&&(new c.Notice(`Archive Project: Invalid settings detected (${i}), resetting to defaults`),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,this.settings.archivePath=u.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}getSourceFolders(){return[(0,c.normalizePath)(this.settings.projectsPath),(0,c.normalizePath)(this.settings.areasPath),(0,c.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let s=this.getSourceFolders();if(s.some(a=>v(e.path,a)))return e;let t=e.parent;for(;t;){if(s.some(a=>v(t.path,a)))return t;t=t.parent}return null}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let s=(0,c.normalizePath)(this.settings.archivePath),t=b(e.path);try{let i=this.getSourceFolders().find(P=>v(e.path,P)),g=i?b(i):"";await this.ensureFolderExists(s);let h=g?(0,c.normalizePath)(`${s}/${g}`):s;await this.ensureFolderExists(h);let f=this.getExistingArchivePaths(h),p=j(h,t,f);if(this.settings.confirmBeforeArchive)return new Promise(P=>{new F(this.app,t,p,async()=>{await this.performArchive(e,p,t,h,i),P()},()=>P()).open()});await this.performArchive(e,p,t,h,i)}catch(a){let i=a instanceof Error?a.message:"Unknown error";new c.Notice(`Failed to archive "${t}": ${i}`),console.error("Archive Project: Failed to archive item",a)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,s,t,a,i){let g=s;for(let h=0;h<S;h++)try{await this.app.vault.rename(e,s);break}catch(f){if(h===S-1)throw f;let p=this.getExistingArchivePaths(a);p.add(s),s=j(a,t,p)}s!==g?new c.Notice(`Archived "${t}" to ${s} (path changed due to conflict)`):new c.Notice(`Archived "${t}" to ${s}`),this.settings.focusAfterArchive&&i&&await this.focusSourceFolder(i)}async ensureFolderExists(e){let s=(0,c.normalizePath)(e),t=this.app.vault.getAbstractFileByPath(s);if(t){if(!(t instanceof c.TFolder))throw new Error(`"${s}" exists but is not a folder`);return}let a=s.split("/").filter(Boolean);for(let i=1;i<=a.length;i++){let g=a.slice(0,i).join("/"),h=this.app.vault.getAbstractFileByPath(g);if(!h)await this.app.vault.createFolder(g);else if(!(h instanceof c.TFolder))throw new Error(`Cannot create folder "${s}": intermediate path "${g}" exists but is not a folder`)}}getExistingArchivePaths(e){let s=new Set,t=this.app.vault.getAbstractFileByPath(e);if(t instanceof c.TFolder)for(let a of t.children)s.add((0,c.normalizePath)(a.path));return s}async focusSourceFolder(e){let s=(0,c.normalizePath)(e),t=this.app.vault.getAbstractFileByPath(s);if(t)try{let a=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!a)return;let i=a.view;typeof i.revealInFolder=="function"&&i.revealInFolder(t)}catch(a){console.debug("Archive Project: Could not focus source folder",a)}}};
