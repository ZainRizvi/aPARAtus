"use strict";var $=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ne=Object.prototype.hasOwnProperty;var ie=(i,s)=>{for(var e in s)$(i,e,{get:s[e],enumerable:!0})},oe=(i,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of ae(s))!ne.call(i,r)&&r!==e&&$(i,r,{get:()=>s[r],enumerable:!(t=re(s,r))||t.enumerable});return i};var le=i=>oe($({},"__esModule",{value:!0}),i);var he={};ie(he,{default:()=>D});module.exports=le(he);var u=require("obsidian");function Y(i,s){let e=Object.keys(s).map(t=>ce(i,t,s[t]));return e.length===1?e[0]:function(){e.forEach(t=>t())}}function ce(i,s,e){let t=i[s],r=i.hasOwnProperty(s),n=r?t:function(){return Object.getPrototypeOf(i)[s].apply(this,arguments)},a=e(n);return t&&Object.setPrototypeOf(a,t),Object.setPrototypeOf(l,a),i[s]=l,o;function l(...c){return a===n&&i[s]===l&&o(),a.apply(this,c)}function o(){i[s]===l&&(r?i[s]=n:delete i[s]),a!==n&&(a=n,Object.setPrototypeOf(l,t||Function))}}var h=require("obsidian");function W(i,s){let e=y(i),t=y(s);return!!(e===t||t.startsWith(e+"/")||e.startsWith(t+"/"))}function q(i){for(let s=0;s<i.length;s++)for(let e=s+1;e<i.length;e++)if(W(i[s],i[e])){let t=y(i[s]),r=y(i[e]);return`PARA folders cannot be nested: "${t}" and "${r}"`}return null}function y(i){return i.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function pe(i){let s=y(i),e=s.lastIndexOf("/");return e===-1?"":s.substring(0,e)}function b(i,s){let e=y(i),t=y(s);return pe(e)===t}function R(i){let s=y(i),e=s.lastIndexOf("/");return e===-1?s:s.substring(e+1)}function k(i,s,e){let t=y(i),r=`${t}/${s}`;if(!e.has(r))return r;let a=new Date().toISOString().split("T")[0],l=`${t}/${s} (Archived ${a})`;if(!e.has(l))return l;let o=2;for(;;){let c=`${t}/${s} (Archived ${a}) (${o})`;if(!e.has(c))return c;if(o++,o>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var H={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function X(i,s,e){let r=["projectsPath","areasPath","resourcesPath","archivePath"].filter(n=>n!==s);for(let n of r){let a=e[n],l=H[n],o=H[s];if(i===a)return`${o} folder cannot be the same as ${l} folder`;if(W(i,a))return`${o} folder cannot be nested with ${l} folder`}return null}function G(i){let s=/^(\d{4})-(\d{2})-(\d{2})/,e=i.match(s);if(!e)return null;let t=parseInt(e[1],10),r=parseInt(e[2],10),n=parseInt(e[3],10),a=new Date(Date.UTC(t,r-1,n));return a.getUTCFullYear()!==t||a.getUTCMonth()!==r-1||a.getUTCDate()!==n?null:a}function J(i,s){return s.mtime-i.mtime}function K(i,s){let e=G(i.name),t=G(s.name);return e&&t?t.getTime()-e.getTime():e&&!t?-1:!e&&t?1:0}async function M(i,s){let e=(0,h.normalizePath)(s);i.vault.getAbstractFileByPath(e)||await i.vault.createFolder(e)}function O(i){return{Project:`# {{name}}

A project is a series of tasks linked to a goal, with a deadline.

## Status
- [ ] In Progress

## Goals
-

## Tasks
-

## Notes
- `,Area:`# {{name}}

An area is a sphere of activity with a standard to maintain over time.

## Responsibilities
-

## Standards
-

## Notes
- `,Resource:`# {{name}}

A resource is a topic or tool you want to reference in the future.

## Overview
-

## Key Points
-

## Related Resources
- `}[i]||`# {{name}}
`}var V=class extends h.AbstractInputSuggest{constructor(s,e){super(s,e)}getSuggestions(s){let e=this.app.vault.getAllLoadedFiles().filter(r=>r instanceof h.TFolder);if(!s)return e;let t=s.toLowerCase();return e.filter(r=>r.path.toLowerCase().includes(t))}renderSuggestion(s,e){e.setText(s.path)}selectSuggestion(s){this.setValue(s.path),this.close()}},P={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1,projectFolderFormat:"YYYY-MM-DD {{name}}",projectTemplatePath:"",areaTemplatePath:"",resourceTemplatePath:"",projectSortOrder:"disabled"},Q={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},E="aparatus-invalid-input",B="aparatus-warning-input";function N(i,s,e,t){let r=s.inputEl;class n extends h.AbstractInputSuggest{constructor(c,d){super(c,d)}getSuggestions(c){let d=e.app.vault.getAllLoadedFiles().filter(F=>typeof F.name=="string"&&F.name.endsWith(".md"));if(!c)return d.slice(0,50);let v=c.toLowerCase();return d.filter(F=>F.path.toLowerCase().includes(v)).slice(0,20)}renderSuggestion(c,d){d.setText(c.path)}selectSuggestion(c){this.setValue(c.path),this.close()}}new n(e.app,r);let a=document.createElement("div");a.classList.add("aparatus-inline-message"),a.style.display="none",a.style.color="var(--text-muted)",i.settingEl.insertAdjacentElement("afterend",a);let l=o=>{if(!o.trim()){a.style.display="none";return}e.app.vault.getAbstractFileByPath(o)?a.style.display="none":(a.textContent=`Template file "${o}" does not exist (will use default template)`,a.style.display="block")};r.addEventListener("blur",async()=>{let o=s.getValue().trim();l(o),await t(o)}),setTimeout(()=>l(s.getValue()),0)}function j(i,s,e,t){let r=s.inputEl;new V(t.app,r);let n=document.createElement("div");n.classList.add("aparatus-inline-message"),n.style.display="none",i.settingEl.insertAdjacentElement("afterend",n);let a=l=>{t.app.vault.getAbstractFileByPath(l)?(r.classList.remove(B),n.style.display="none"):(r.classList.add(B),n.textContent=`Folder "${l}" does not exist (will be created automatically)`,n.style.display="block")};s.setPlaceholder(Q[e]).setValue(t.settings[e]),setTimeout(()=>a(t.settings[e]),0),r.addEventListener("blur",async()=>{let o=s.getValue().trim().replace(/\/+$/,"")||Q[e],c=X(o,e,t.settings);c?(r.classList.add(E),r.classList.remove(B),n.textContent=c,n.style.color="var(--text-error)",n.style.display="block",s.setValue(t.settings[e]),setTimeout(()=>{r.classList.remove(E),n.style.color="var(--color-yellow)",a(t.settings[e])},100)):(r.classList.remove(E),a(o),t.settings[e]=o,await t.saveSettings())})}var C=class extends h.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty();let e=new h.Setting(s).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)");e.addText(p=>j(e,p,"projectsPath",this.plugin));let t=new h.Setting(s).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)");t.addText(p=>j(t,p,"areasPath",this.plugin));let r=new h.Setting(s).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)");r.addText(p=>j(r,p,"resourcesPath",this.plugin));let n=new h.Setting(s).setName("Archive folder").setDesc("Path where archived items will be moved");n.addText(p=>j(n,p,"archivePath",this.plugin));let a=new h.Setting(s).setName("Project folder format"),l=document.createDocumentFragment();l.appendText("Use {{name}} for project name. Supports ");let o=document.createElement("a");o.href="https://momentjs.com/docs/#/displaying/format/",o.textContent="Moment.js tokens",o.setAttr("target","_blank"),l.appendChild(o),l.appendText(": YYYY, MM, DD, etc."),a.setDesc(l);let c=document.createElement("div");c.classList.add("aparatus-inline-message"),c.style.color="var(--text-muted)",a.addText(p=>{let m=p.inputEl,f=g=>{let S=g.includes("{{name}}");if(S){let w="My Project",T=window.moment(),te=g.replace(/\{\{name\}\}/g,`[${w}]`),se=T.format(te);c.textContent=`Preview: ${se}`,c.style.color="var(--text-muted)",m.style.borderColor="",m.classList.remove(E)}else c.textContent="Format must contain {{name}}",c.style.color="var(--text-error)",m.classList.add(E);return S};p.setPlaceholder("YYYY-MM-DD {{name}}").setValue(this.plugin.settings.projectFolderFormat),f(this.plugin.settings.projectFolderFormat),m.addEventListener("input",()=>{let g=p.getValue().trim()||P.projectFolderFormat;f(g)}),m.addEventListener("blur",async()=>{let g=p.getValue().trim()||P.projectFolderFormat;f(g)?(this.plugin.settings.projectFolderFormat=g,await this.plugin.saveSettings()):(p.setValue(this.plugin.settings.projectFolderFormat),f(this.plugin.settings.projectFolderFormat))})}),a.settingEl.insertAdjacentElement("afterend",c),new h.Setting(s).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(p=>p.setValue(this.plugin.settings.focusAfterArchive).onChange(async m=>{this.plugin.settings.focusAfterArchive=m,await this.plugin.saveSettings()})),new h.Setting(s).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(p=>p.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async m=>{this.plugin.settings.confirmBeforeArchive=m,await this.plugin.saveSettings()})),new h.Setting(s).setName("Project folder sort order").setDesc("How to sort projects in the Projects folder").addDropdown(p=>p.addOption("disabled","Disabled (manual order)").addOption("lastModified","Last modified (newest first)").addOption("datePrefix","Date prefix (newer first)").setValue(this.plugin.settings.projectSortOrder).onChange(async m=>{this.plugin.settings.projectSortOrder=m,await this.plugin.saveSettings(),this.plugin.installSortingPatch();let f=this.plugin.app.workspace.getLeavesOfType("file-explorer")[0];f&&f.view.requestSort?.()})),s.createEl("h3",{text:"Templates"});let d=new h.Setting(s).setName("Project template").setDesc("Template file to apply when creating new projects (optional)");d.addText(p=>{N(d,p,this.plugin,async m=>{this.plugin.settings.projectTemplatePath=m,await this.plugin.saveSettings()}),p.setValue(this.plugin.settings.projectTemplatePath)}),d.addButton(p=>p.setButtonText("Generate Default").onClick(async()=>{let m=O("Project"),f="Templates";await M(this.plugin.app,f);let g=`${f}/Project.md`;if(this.plugin.app.vault.getAbstractFileByPath(g)){new h.Notice("Template already exists at "+g);return}try{await this.plugin.app.vault.create(g,m),this.plugin.settings.projectTemplatePath=g,await this.plugin.saveSettings(),this.display(),new h.Notice("Created project template at "+g)}catch(w){let T=w instanceof Error?w.message:"Unknown error";new h.Notice("Failed to create template: "+T)}}));let v=new h.Setting(s).setName("Area template").setDesc("Template file to apply when creating new areas (optional)");v.addText(p=>{N(v,p,this.plugin,async m=>{this.plugin.settings.areaTemplatePath=m,await this.plugin.saveSettings()}),p.setValue(this.plugin.settings.areaTemplatePath)}),v.addButton(p=>p.setButtonText("Generate Default").onClick(async()=>{let m=O("Area"),f="Templates";await M(this.plugin.app,f);let g=`${f}/Area.md`;if(this.plugin.app.vault.getAbstractFileByPath(g)){new h.Notice("Template already exists at "+g);return}try{await this.plugin.app.vault.create(g,m),this.plugin.settings.areaTemplatePath=g,await this.plugin.saveSettings(),this.display(),new h.Notice("Created area template at "+g)}catch(w){let T=w instanceof Error?w.message:"Unknown error";new h.Notice("Failed to create template: "+T)}}));let F=new h.Setting(s).setName("Resource template").setDesc("Template file to apply when creating new resources (optional)");F.addText(p=>{N(F,p,this.plugin,async m=>{this.plugin.settings.resourceTemplatePath=m,await this.plugin.saveSettings()}),p.setValue(this.plugin.settings.resourceTemplatePath)}),F.addButton(p=>p.setButtonText("Generate Default").onClick(async()=>{let m=O("Resource"),f="Templates";await M(this.plugin.app,f);let g=`${f}/Resource.md`;if(this.plugin.app.vault.getAbstractFileByPath(g)){new h.Notice("Template already exists at "+g);return}try{await this.plugin.app.vault.create(g,m),this.plugin.settings.resourceTemplatePath=g,await this.plugin.saveSettings(),this.display(),new h.Notice("Created resource template at "+g)}catch(w){let T=w instanceof Error?w.message:"Unknown error";new h.Notice("Failed to create template: "+T)}}))}};var _=require("obsidian"),L=class extends _.Modal{constructor(e,t,r,n,a){super(e);this.confirmed=!1;this.itemName=t,this.destPath=r,this.onConfirm=n,this.onCancel=a}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let n=t.createEl("button",{text:"Archive",cls:"mod-cta"});n.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),n.focus(),this.keydownHandler=a=>{a.key==="Enter"&&!a.isComposing?(a.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):a.key==="Escape"&&(a.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},x=class extends _.Modal{constructor(s,e,t,r){super(s),this.title=e,this.placeholder=t,this.onSubmit=r}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:this.title});let e=s.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.style.marginBottom="1em",e.focus();let t=s.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Create",cls:"mod-cta"}).addEventListener("click",()=>{let a=e.value.trim();a&&(this.onSubmit(a),this.close())}),e.addEventListener("keydown",a=>{if(a.key==="Enter"&&!a.isComposing){a.preventDefault();let l=e.value.trim();l&&(this.onSubmit(l),this.close())}else a.key==="Escape"&&(a.preventDefault(),this.close())})}onClose(){let{contentEl:s}=this;s.empty()}};var A=require("obsidian");async function I(i,s){let e=(0,A.normalizePath)(s),t=i.vault.getAbstractFileByPath(e);if(t){if(!(t instanceof A.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let r=e.split("/").filter(Boolean);for(let n=1;n<=r.length;n++){let a=r.slice(0,n).join("/"),l=i.vault.getAbstractFileByPath(a);if(!l)await i.vault.createFolder(a);else if(!(l instanceof A.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${a}" exists but is not a folder`)}}function U(i,s){let e=new Set,t=i.vault.getAbstractFileByPath(s);if(t instanceof A.TFolder)for(let r of t.children)e.add((0,A.normalizePath)(r.path));return e}async function Z(i,s){let e=(0,A.normalizePath)(s),t=i.vault.getAbstractFileByPath(e);if(t)try{let r=i.workspace.getLeavesOfType("file-explorer")[0];if(!r)return;let n=r.view;typeof n.revealInFolder=="function"&&n.revealInFolder(t)}catch(r){console.debug("aPARAtus: Could not focus folder",r)}}function z(i){let s=0,e=t=>{for(let r of t.children)if(r instanceof A.TFolder)e(r);else{let n=r;typeof n.stat?.mtime=="number"&&(s=Math.max(s,n.stat.mtime))}};return e(i),s}var ee=3,D=class extends u.Plugin{constructor(){super(...arguments);this.settings=P;this.archivingItems=new Set;this.sortingPatchUninstaller=null}async onload(){await this.loadSettings(),this.app.workspace.onLayoutReady(()=>{this.installSortingPatch()}),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.installSortingPatch()})),this.addSettingTab(new C(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let r=this.findTopLevelItem(t);return r?(e||this.archiveItem(r),!0):!1}}),this.addCommand({id:"create-project",name:"Create Project",callback:()=>{new x(this.app,"Create Project","Project name",e=>this.createParaItem(e,"projectsPath","Project")).open()}}),this.addCommand({id:"create-area",name:"Create Area",callback:()=>{new x(this.app,"Create Area","Area name",e=>this.createParaItem(e,"areasPath","Area")).open()}}),this.addCommand({id:"create-resource",name:"Create Resource",callback:()=>{new x(this.app,"Create Resource","Resource name",e=>this.createParaItem(e,"resourcesPath","Resource")).open()}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof u.TFolder)&&!(t instanceof u.TFile)||!this.getSourceFolders().some(a=>b(t.path,a))||e.addItem(a=>{a.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}onunload(){this.sortingPatchUninstaller?.(),this.archivingItems.clear()}async loadSettings(){this.settings=Object.assign({},P,await this.loadData());let e=this.getSourceFolders(),t=(0,u.normalizePath)(this.settings.archivePath);if(e.includes(t)){new u.Notice("aPARAtus: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=P.projectsPath,this.settings.areasPath=P.areasPath,this.settings.resourcesPath=P.resourcesPath,this.settings.archivePath=P.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new u.Notice("aPARAtus: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=P.projectsPath,this.settings.areasPath=P.areasPath,this.settings.resourcesPath=P.resourcesPath,await this.saveSettings();return}let n=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],a=q(n);a&&(new u.Notice(`aPARAtus: Invalid settings detected (${a}), resetting to defaults`),this.settings.projectsPath=P.projectsPath,this.settings.areasPath=P.areasPath,this.settings.resourcesPath=P.resourcesPath,this.settings.archivePath=P.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}isTemplaterAvailable(){try{return!!this.app.plugins?.plugins?.["templater-obsidian"]}catch{return!1}}isCoreTemplatesAvailable(){try{return!!this.app.internalPlugins?.plugins?.templates}catch{return!1}}async applyTemplate(e,t,r){if(!t.trim())return`# ${r}
`;let n=this.app.vault.getAbstractFileByPath(t);if(!(n instanceof u.TFile))return console.warn(`aPARAtus: Template file not found at ${t}, using default`),`# ${r}
`;try{if(this.isTemplaterAvailable()){let o=this.app.plugins?.plugins?.["templater-obsidian"]?.templater;if(o)return await o.parse_template({template_file:n,target_file:e})}return this.isCoreTemplatesAvailable()?(await this.app.vault.read(n)).replace(/{{name}}/g,r):(await this.app.vault.read(n)).replace(/{{name}}/g,r)}catch(a){let l=a instanceof Error?a.message:"Unknown error";return console.warn(`aPARAtus: Failed to apply template: ${l}, using default`),`# ${r}
`}}formatProjectName(e,t){let r=window.moment(),n=t.replace(/\{\{name\}\}/g,`[${e}]`);return r.format(n)}async createParaItem(e,t,r){let n=this.settings[t],a=e;t==="projectsPath"&&(a=this.formatProjectName(e,this.settings.projectFolderFormat));let l=(0,u.normalizePath)(`${n}/${a}`);if(this.app.vault.getAbstractFileByPath(l)){new u.Notice(`${r} "${e}" already exists`);return}try{await I(this.app,n),await this.app.vault.createFolder(l);let o=(0,u.normalizePath)(`${l}/index.md`),c="";t==="projectsPath"?c=this.settings.projectTemplatePath:t==="areasPath"?c=this.settings.areaTemplatePath:t==="resourcesPath"&&(c=this.settings.resourceTemplatePath);let d=await this.app.vault.create(o,""),v=await this.applyTemplate(d,c,e);v&&await this.app.vault.modify(d,v),await this.app.workspace.getLeaf().openFile(d),new u.Notice(`Created ${r.toLowerCase()} "${e}"`)}catch(o){let c=o instanceof Error?o.message:"Unknown error";new u.Notice(`Failed to create ${r.toLowerCase()}: ${c}`),console.error(`aPARAtus: Failed to create ${r}`,o)}}getSourceFolders(){return[(0,u.normalizePath)(this.settings.projectsPath),(0,u.normalizePath)(this.settings.areasPath),(0,u.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let t=this.getSourceFolders();if(t.some(n=>b(e.path,n)))return e;let r=e.parent;for(;r;){if(t.some(n=>b(r.path,n)))return r;r=r.parent}return null}installSortingPatch(){if(this.sortingPatchUninstaller?.(),this.sortingPatchUninstaller=null,this.settings.projectSortOrder==="disabled")return;let e=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!e){console.warn("aPARAtus: File explorer not found, cannot install sorting patch");return}let t=e.view;if(typeof t.getSortedFolderItems!="function"){console.warn("aPARAtus: getSortedFolderItems not found on file explorer view");return}if(typeof t.requestSort!="function"){console.warn("aPARAtus: requestSort not found on file explorer view");return}let r=(0,u.normalizePath)(this.settings.projectsPath),n=this;console.log("aPARAtus: Installing sorting patch for",r,"with order",this.settings.projectSortOrder),this.sortingPatchUninstaller=Y(t.constructor.prototype,{getSortedFolderItems(a){return function(l){if(console.log("aPARAtus: getSortedFolderItems called for",l.path),l.path!==r)return a.call(this,l);console.log("aPARAtus: Intercepting sort for Projects folder, order:",n.settings.projectSortOrder);try{let o=a.call(this,l);console.log("aPARAtus: Original items:",o.map(d=>d.name));let c=n.sortProjectItems(o);return console.log("aPARAtus: Sorted items:",c.map(d=>d.name)),c}catch(o){return console.error("aPARAtus: Sorting failed, using default",o),a.call(this,l)}}}})}sortProjectItems(e){let t=[...e];return this.settings.projectSortOrder==="lastModified"?t.sort((r,n)=>{let a=r instanceof u.TFolder?z(r):r.stat?.mtime??0,l=n instanceof u.TFolder?z(n):n.stat?.mtime??0;return J({mtime:a},{mtime:l})}):this.settings.projectSortOrder==="datePrefix"&&t.sort((r,n)=>K({name:r.name},{name:n.name})),t}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,u.normalizePath)(this.settings.archivePath),r=R(e.path);try{let a=this.getSourceFolders().find(v=>b(e.path,v)),l=a?R(a):"";await I(this.app,t);let o=l?(0,u.normalizePath)(`${t}/${l}`):t;await I(this.app,o);let c=U(this.app,o),d=k(o,r,c);if(this.settings.confirmBeforeArchive)return new Promise(v=>{new L(this.app,r,d,async()=>{await this.performArchive(e,d,r,o,a),v()},()=>v()).open()});await this.performArchive(e,d,r,o,a)}catch(n){let a=n instanceof Error?n.message:"Unknown error";new u.Notice(`Failed to archive "${r}": ${a}`),console.error("aPARAtus: Failed to archive item",n)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,r,n,a){let l=t;for(let o=0;o<ee;o++)try{await this.app.vault.rename(e,t);break}catch(c){if(o===ee-1)throw c;let d=U(this.app,n);d.add(t),t=k(n,r,d)}t!==l?new u.Notice(`Archived "${r}" to ${t} (path changed due to conflict)`):new u.Notice(`Archived "${r}" to ${t}`),this.settings.focusAfterArchive&&a&&await Z(this.app,a)}};
