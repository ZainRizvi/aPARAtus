"use strict";var x=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var G=(n,s)=>{for(var e in s)x(n,e,{get:s[e],enumerable:!0})},X=(n,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of H(s))!W.call(n,r)&&r!==e&&x(n,r,{get:()=>s[r],enumerable:!(t=U(s,r))||t.enumerable});return n};var q=n=>X(x({},"__esModule",{value:!0}),n);var Q={};G(Q,{default:()=>S});module.exports=q(Q);var h=require("obsidian");var g=require("obsidian");function C(n,s){let e=m(n),t=m(s);return!!(e===t||t.startsWith(e+"/")||e.startsWith(t+"/"))}function N(n){for(let s=0;s<n.length;s++)for(let e=s+1;e<n.length;e++)if(C(n[s],n[e])){let t=m(n[s]),r=m(n[e]);return`PARA folders cannot be nested: "${t}" and "${r}"`}return null}function m(n){return n.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function K(n){let s=m(n),e=s.lastIndexOf("/");return e===-1?"":s.substring(0,e)}function A(n,s){let e=m(n),t=m(s);return K(e)===t}function j(n){let s=m(n),e=s.lastIndexOf("/");return e===-1?s:s.substring(e+1)}function T(n,s,e){let t=m(n),r=`${t}/${s}`;if(!e.has(r))return r;let o=new Date().toISOString().split("T")[0],c=`${t}/${s} (Archived ${o})`;if(!e.has(c))return c;let i=2;for(;;){let d=`${t}/${s} (Archived ${o}) (${i})`;if(!e.has(d))return d;if(i++,i>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var u={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1,projectFolderFormat:"YYYY-MM-DD {{name}}"},M={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},R={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function J(n,s,e){let r=["projectsPath","areasPath","resourcesPath","archivePath"].filter(a=>a!==s);for(let a of r){let o=e[a],c=M[a],i=M[s];if(n===o)return`${i} folder cannot be the same as ${c} folder`;if(C(n,o))return`${i} folder cannot be nested with ${c} folder`}return null}var $="para-manager-invalid-input",I="para-manager-warning-input";function w(n,s,e,t){let r=s.inputEl,a=document.createElement("div");a.style.marginTop="-8px",a.style.marginBottom="16px",a.style.fontSize="var(--font-ui-smaller)",a.style.color="var(--color-yellow)",a.style.display="none",n.settingEl.insertAdjacentElement("afterend",a);let o=c=>{t.app.vault.getAbstractFileByPath(c)?(r.classList.remove(I),r.style.borderColor="",r.style.backgroundColor="",a.style.display="none"):(r.classList.add(I),r.style.borderColor="var(--color-yellow)",r.style.backgroundColor="rgba(var(--color-yellow-rgb), 0.1)",a.textContent=`Folder "${c}" does not exist (will be created automatically)`,a.style.display="block")};s.setPlaceholder(R[e]).setValue(t.settings[e]),setTimeout(()=>o(t.settings[e]),0),r.addEventListener("blur",async()=>{let i=s.getValue().trim().replace(/\/+$/,"")||R[e],d=J(i,e,t.settings);d?(r.classList.add($),r.classList.remove(I),r.style.borderColor="var(--text-error)",r.style.backgroundColor="rgba(var(--color-red-rgb), 0.1)",a.textContent=d,a.style.color="var(--text-error)",a.style.display="block",s.setValue(t.settings[e]),setTimeout(()=>{r.classList.remove($),r.style.borderColor="",r.style.backgroundColor="",a.style.color="var(--color-yellow)",o(t.settings[e])},100)):(r.classList.remove($),o(i),t.settings[e]=i,await t.saveSettings())})}var y=class extends g.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty();let e=new g.Setting(s).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)");e.addText(l=>w(e,l,"projectsPath",this.plugin));let t=new g.Setting(s).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)");t.addText(l=>w(t,l,"areasPath",this.plugin));let r=new g.Setting(s).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)");r.addText(l=>w(r,l,"resourcesPath",this.plugin));let a=new g.Setting(s).setName("Archive folder").setDesc("Path where archived items will be moved");a.addText(l=>w(a,l,"archivePath",this.plugin));let o=new g.Setting(s).setName("Project folder format"),c=document.createDocumentFragment();c.appendText("Use {{name}} for project name. Supports ");let i=document.createElement("a");i.href="https://momentjs.com/docs/#/displaying/format/",i.textContent="Moment.js tokens",i.setAttr("target","_blank"),c.appendChild(i),c.appendText(": YYYY, MM, DD, etc."),o.setDesc(c);let d=document.createElement("div");d.style.marginTop="-8px",d.style.marginBottom="16px",d.style.fontSize="var(--font-ui-smaller)",d.style.color="var(--text-muted)",o.addText(l=>{let p=l.inputEl,F=f=>{let D=f.includes("{{name}}");if(D){let _="My Project",O=window.moment(),V=f.replace(/\{\{name\}\}/g,`[${_}]`),Y=O.format(V);d.textContent=`Preview: ${Y}`,d.style.color="var(--text-muted)",p.style.borderColor=""}else d.textContent="Format must contain {{name}}",d.style.color="var(--text-error)",p.style.borderColor="var(--text-error)";return D};l.setPlaceholder("YYYY-MM-DD {{name}}").setValue(this.plugin.settings.projectFolderFormat),F(this.plugin.settings.projectFolderFormat),p.addEventListener("input",()=>{let f=l.getValue().trim()||u.projectFolderFormat;F(f)}),p.addEventListener("blur",async()=>{let f=l.getValue().trim()||u.projectFolderFormat;F(f)?(this.plugin.settings.projectFolderFormat=f,await this.plugin.saveSettings()):(l.setValue(this.plugin.settings.projectFolderFormat),F(this.plugin.settings.projectFolderFormat))})}),o.settingEl.insertAdjacentElement("afterend",d),new g.Setting(s).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(l=>l.setValue(this.plugin.settings.focusAfterArchive).onChange(async p=>{this.plugin.settings.focusAfterArchive=p,await this.plugin.saveSettings()})),new g.Setting(s).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(l=>l.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async p=>{this.plugin.settings.confirmBeforeArchive=p,await this.plugin.saveSettings()}))}};var k=require("obsidian"),b=class extends k.Modal{constructor(e,t,r,a,o){super(e);this.confirmed=!1;this.itemName=t,this.destPath=r,this.onConfirm=a,this.onCancel=o}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let a=t.createEl("button",{text:"Archive",cls:"mod-cta"});a.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),a.focus(),this.keydownHandler=o=>{o.key==="Enter"&&!o.isComposing?(o.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):o.key==="Escape"&&(o.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},P=class extends k.Modal{constructor(s,e,t,r){super(s),this.title=e,this.placeholder=t,this.onSubmit=r}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:this.title});let e=s.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.style.marginBottom="1em",e.focus();let t=s.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Create",cls:"mod-cta"}).addEventListener("click",()=>{let o=e.value.trim();o&&(this.onSubmit(o),this.close())}),e.addEventListener("keydown",o=>{if(o.key==="Enter"&&!o.isComposing){o.preventDefault();let c=e.value.trim();c&&(this.onSubmit(c),this.close())}else o.key==="Escape"&&(o.preventDefault(),this.close())})}onClose(){let{contentEl:s}=this;s.empty()}};var v=require("obsidian");async function E(n,s){let e=(0,v.normalizePath)(s),t=n.vault.getAbstractFileByPath(e);if(t){if(!(t instanceof v.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let r=e.split("/").filter(Boolean);for(let a=1;a<=r.length;a++){let o=r.slice(0,a).join("/"),c=n.vault.getAbstractFileByPath(o);if(!c)await n.vault.createFolder(o);else if(!(c instanceof v.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${o}" exists but is not a folder`)}}function L(n,s){let e=new Set,t=n.vault.getAbstractFileByPath(s);if(t instanceof v.TFolder)for(let r of t.children)e.add((0,v.normalizePath)(r.path));return e}async function B(n,s){let e=(0,v.normalizePath)(s),t=n.vault.getAbstractFileByPath(e);if(t)try{let r=n.workspace.getLeavesOfType("file-explorer")[0];if(!r)return;let a=r.view;typeof a.revealInFolder=="function"&&a.revealInFolder(t)}catch(r){console.debug("PARA Manager: Could not focus folder",r)}}var z=3,S=class extends h.Plugin{constructor(){super(...arguments);this.settings=u;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new y(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let r=this.findTopLevelItem(t);return r?(e||this.archiveItem(r),!0):!1}}),this.addCommand({id:"create-project",name:"Create Project",callback:()=>{new P(this.app,"Create Project","Project name",e=>this.createParaItem(e,"projectsPath","Project")).open()}}),this.addCommand({id:"create-area",name:"Create Area",callback:()=>{new P(this.app,"Create Area","Area name",e=>this.createParaItem(e,"areasPath","Area")).open()}}),this.addCommand({id:"create-resource",name:"Create Resource",callback:()=>{new P(this.app,"Create Resource","Resource name",e=>this.createParaItem(e,"resourcesPath","Resource")).open()}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof h.TFolder)&&!(t instanceof h.TFile)||!this.getSourceFolders().some(o=>A(t.path,o))||e.addItem(o=>{o.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}async loadSettings(){this.settings=Object.assign({},u,await this.loadData());let e=this.getSourceFolders(),t=(0,h.normalizePath)(this.settings.archivePath);if(e.includes(t)){new h.Notice("PARA Manager: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,this.settings.archivePath=u.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new h.Notice("PARA Manager: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,await this.saveSettings();return}let a=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],o=N(a);o&&(new h.Notice(`PARA Manager: Invalid settings detected (${o}), resetting to defaults`),this.settings.projectsPath=u.projectsPath,this.settings.areasPath=u.areasPath,this.settings.resourcesPath=u.resourcesPath,this.settings.archivePath=u.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}formatProjectName(e,t){let r=window.moment(),a=t.replace(/\{\{name\}\}/g,`[${e}]`);return r.format(a)}async createParaItem(e,t,r){let a=this.settings[t],o=e;t==="projectsPath"&&(o=this.formatProjectName(e,this.settings.projectFolderFormat));let c=(0,h.normalizePath)(`${a}/${o}`);if(this.app.vault.getAbstractFileByPath(c)){new h.Notice(`${r} "${e}" already exists`);return}try{await E(this.app,a),await this.app.vault.createFolder(c);let i=(0,h.normalizePath)(`${c}/index.md`),d=`# ${e}
`,l=await this.app.vault.create(i,d);await this.app.workspace.getLeaf().openFile(l),new h.Notice(`Created ${r.toLowerCase()} "${e}"`)}catch(i){let d=i instanceof Error?i.message:"Unknown error";new h.Notice(`Failed to create ${r.toLowerCase()}: ${d}`),console.error(`PARA Manager: Failed to create ${r}`,i)}}getSourceFolders(){return[(0,h.normalizePath)(this.settings.projectsPath),(0,h.normalizePath)(this.settings.areasPath),(0,h.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let t=this.getSourceFolders();if(t.some(a=>A(e.path,a)))return e;let r=e.parent;for(;r;){if(t.some(a=>A(r.path,a)))return r;r=r.parent}return null}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,h.normalizePath)(this.settings.archivePath),r=j(e.path);try{let o=this.getSourceFolders().find(p=>A(e.path,p)),c=o?j(o):"";await E(this.app,t);let i=c?(0,h.normalizePath)(`${t}/${c}`):t;await E(this.app,i);let d=L(this.app,i),l=T(i,r,d);if(this.settings.confirmBeforeArchive)return new Promise(p=>{new b(this.app,r,l,async()=>{await this.performArchive(e,l,r,i,o),p()},()=>p()).open()});await this.performArchive(e,l,r,i,o)}catch(a){let o=a instanceof Error?a.message:"Unknown error";new h.Notice(`Failed to archive "${r}": ${o}`),console.error("PARA Manager: Failed to archive item",a)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,r,a,o){let c=t;for(let i=0;i<z;i++)try{await this.app.vault.rename(e,t);break}catch(d){if(i===z-1)throw d;let l=L(this.app,a);l.add(t),t=T(a,r,l)}t!==c?new h.Notice(`Archived "${r}" to ${t} (path changed due to conflict)`):new h.Notice(`Archived "${r}" to ${t}`),this.settings.focusAfterArchive&&o&&await B(this.app,o)}};
