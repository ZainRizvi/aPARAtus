"use strict";var u=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var T=(n,s)=>{for(var t in s)u(n,t,{get:s[t],enumerable:!0})},b=(n,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of y(s))!S.call(n,i)&&i!==t&&u(n,i,{get:()=>s[i],enumerable:!(e=E(s,i))||e.enumerable});return n};var F=n=>b(u({},"__esModule",{value:!0}),n);var $={};T($,{default:()=>f});module.exports=F($);var o=require("obsidian");var h=require("obsidian"),g={projectsPath:"Projects",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1},v=class extends h.PluginSettingTab{constructor(s,t){super(s,t),this.plugin=t}display(){let{containerEl:s}=this;s.empty(),new h.Setting(s).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)").addText(t=>t.setPlaceholder("Projects").setValue(this.plugin.settings.projectsPath).onChange(async e=>{let i=e.trim().replace(/\/+$/,"")||"Projects";if(i===this.plugin.settings.archivePath){new h.Notice("Projects folder cannot be the same as Archive folder"),t.setValue(this.plugin.settings.projectsPath);return}this.plugin.settings.projectsPath=i,await this.plugin.saveSettings()})),new h.Setting(s).setName("Archive folder").setDesc("Path where archived projects will be moved").addText(t=>t.setPlaceholder("Archive").setValue(this.plugin.settings.archivePath).onChange(async e=>{let i=e.trim().replace(/\/+$/,"")||"Archive";if(i===this.plugin.settings.projectsPath){new h.Notice("Archive folder cannot be the same as Projects folder"),t.setValue(this.plugin.settings.archivePath);return}this.plugin.settings.archivePath=i,await this.plugin.saveSettings()})),new h.Setting(s).setName("Focus Projects folder after archive").setDesc("Return focus to the Projects folder in the file explorer after archiving").addToggle(t=>t.setValue(this.plugin.settings.focusAfterArchive).onChange(async e=>{this.plugin.settings.focusAfterArchive=e,await this.plugin.saveSettings()})),new h.Setting(s).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(t=>t.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async e=>{this.plugin.settings.confirmBeforeArchive=e,await this.plugin.saveSettings()}))}};function d(n){return n.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function x(n){let s=d(n),t=s.lastIndexOf("/");return t===-1?"":s.substring(0,t)}function A(n,s){let t=d(n),e=d(s);return x(t)===e}function w(n){let s=d(n),t=s.lastIndexOf("/");return t===-1?s:s.substring(t+1)}function P(n,s,t){let e=d(n),i=`${e}/${s}`;if(!t.has(i))return i;let c=new Date().toISOString().split("T")[0],a=`${e}/${s} (Archived ${c})`;if(!t.has(a))return a;let l=2;for(;;){let p=`${e}/${s} (Archived ${c}) (${l})`;if(!t.has(p))return p;if(l++,l>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var j=3,m=class extends o.Modal{constructor(t,e,i,r,c){super(t);this.confirmed=!1;this.folderName=e,this.destPath=i,this.onConfirm=r,this.onCancel=c}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:"Archive Project?"}),t.createEl("p",{text:`Move "${this.folderName}" to:`}),t.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let r=e.createEl("button",{text:"Archive",cls:"mod-cta"});r.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),r.focus();let c=a=>{a.key==="Enter"&&!a.isComposing?(a.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):a.key==="Escape"&&(a.preventDefault(),this.close())};t.addEventListener("keydown",c)}onClose(){let{contentEl:t}=this;t.empty(),this.confirmed||this.onCancel()}},f=class extends o.Plugin{constructor(){super(...arguments);this.settings=g}async onload(){await this.loadSettings(),this.addSettingTab(new v(this.app,this)),this.registerEvent(this.app.workspace.on("file-menu",(t,e)=>{if(!(e instanceof o.TFolder)&&!(e instanceof o.TFile))return;let i=(0,o.normalizePath)(this.settings.projectsPath);A(e.path,i)&&t.addItem(r=>{r.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(e)})})}))}async loadSettings(){this.settings=Object.assign({},g,await this.loadData()),this.settings.projectsPath===this.settings.archivePath&&(new o.Notice("Archive Project: Invalid settings detected (paths match), resetting to defaults"),this.settings.projectsPath=g.projectsPath,this.settings.archivePath=g.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}async archiveItem(t){let e=(0,o.normalizePath)(this.settings.archivePath),i=w(t.path);try{await this.ensureFolderExists(e);let r=this.getExistingArchivePaths(e),c=P(e,i,r);if(this.settings.confirmBeforeArchive)return new Promise(a=>{new m(this.app,i,c,async()=>{await this.performArchive(t,c,i,e),a()},()=>a()).open()});await this.performArchive(t,c,i,e)}catch(r){let c=r instanceof Error?r.message:"Unknown error";new o.Notice(`Failed to archive "${i}": ${c}`),console.error("Archive Project: Failed to archive item",r)}}async performArchive(t,e,i,r){let c=e;for(let a=0;a<j;a++)try{await this.app.vault.rename(t,e);break}catch(l){if(a===j-1)throw l;let p=this.getExistingArchivePaths(r);p.add(e),e=P(r,i,p)}e!==c?new o.Notice(`Archived "${i}" to ${e} (path changed due to conflict)`):new o.Notice(`Archived "${i}" to ${e}`),this.settings.focusAfterArchive&&await this.focusProjectsFolder()}async ensureFolderExists(t){let e=this.app.vault.getAbstractFileByPath(t);if(!e)await this.app.vault.createFolder(t);else if(!(e instanceof o.TFolder))throw new Error(`"${t}" exists but is not a folder`)}getExistingArchivePaths(t){let e=new Set,i=this.app.vault.getAbstractFileByPath(t);if(i instanceof o.TFolder)for(let r of i.children)e.add((0,o.normalizePath)(r.path));return e}async focusProjectsFolder(){let t=(0,o.normalizePath)(this.settings.projectsPath),e=this.app.vault.getAbstractFileByPath(t);if(e)try{let i=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!i)return;let r=i.view;typeof r.revealInFolder=="function"&&r.revealInFolder(e)}catch(i){console.debug("Archive Project: Could not focus Projects folder",i)}}};
