"use strict";var v=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var E=(c,r)=>{for(var e in r)v(c,e,{get:r[e],enumerable:!0})},T=(c,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of b(r))!F.call(c,s)&&s!==e&&v(c,s,{get:()=>r[s],enumerable:!(t=S(r,s))||t.enumerable});return c};var I=c=>T(v({},"__esModule",{value:!0}),c);var C={};E(C,{default:()=>f});module.exports=I(C);var n=require("obsidian");var a=require("obsidian"),l={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1},p=class extends a.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),new a.Setting(r).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)").addText(e=>e.setPlaceholder("Projects").setValue(this.plugin.settings.projectsPath).onChange(async t=>{let s=t.trim().replace(/\/+$/,"")||"Projects";if(s===this.plugin.settings.archivePath){new a.Notice("Projects folder cannot be the same as Archive folder"),e.setValue(this.plugin.settings.projectsPath);return}if(s===this.plugin.settings.areasPath){new a.Notice("Projects folder cannot be the same as Areas folder"),e.setValue(this.plugin.settings.projectsPath);return}if(s===this.plugin.settings.resourcesPath){new a.Notice("Projects folder cannot be the same as Resources folder"),e.setValue(this.plugin.settings.projectsPath);return}this.plugin.settings.projectsPath=s,await this.plugin.saveSettings()})),new a.Setting(r).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)").addText(e=>e.setPlaceholder("Areas").setValue(this.plugin.settings.areasPath).onChange(async t=>{let s=t.trim().replace(/\/+$/,"")||"Areas";if(s===this.plugin.settings.archivePath){new a.Notice("Areas folder cannot be the same as Archive folder"),e.setValue(this.plugin.settings.areasPath);return}if(s===this.plugin.settings.projectsPath){new a.Notice("Areas folder cannot be the same as Projects folder"),e.setValue(this.plugin.settings.areasPath);return}if(s===this.plugin.settings.resourcesPath){new a.Notice("Areas folder cannot be the same as Resources folder"),e.setValue(this.plugin.settings.areasPath);return}this.plugin.settings.areasPath=s,await this.plugin.saveSettings()})),new a.Setting(r).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)").addText(e=>e.setPlaceholder("Resources").setValue(this.plugin.settings.resourcesPath).onChange(async t=>{let s=t.trim().replace(/\/+$/,"")||"Resources";if(s===this.plugin.settings.archivePath){new a.Notice("Resources folder cannot be the same as Archive folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(s===this.plugin.settings.projectsPath){new a.Notice("Resources folder cannot be the same as Projects folder"),e.setValue(this.plugin.settings.resourcesPath);return}if(s===this.plugin.settings.areasPath){new a.Notice("Resources folder cannot be the same as Areas folder"),e.setValue(this.plugin.settings.resourcesPath);return}this.plugin.settings.resourcesPath=s,await this.plugin.saveSettings()})),new a.Setting(r).setName("Archive folder").setDesc("Path where archived items will be moved").addText(e=>e.setPlaceholder("Archive").setValue(this.plugin.settings.archivePath).onChange(async t=>{let s=t.trim().replace(/\/+$/,"")||"Archive";if(s===this.plugin.settings.projectsPath){new a.Notice("Archive folder cannot be the same as Projects folder"),e.setValue(this.plugin.settings.archivePath);return}if(s===this.plugin.settings.areasPath){new a.Notice("Archive folder cannot be the same as Areas folder"),e.setValue(this.plugin.settings.archivePath);return}if(s===this.plugin.settings.resourcesPath){new a.Notice("Archive folder cannot be the same as Resources folder"),e.setValue(this.plugin.settings.archivePath);return}this.plugin.settings.archivePath=s,await this.plugin.saveSettings()})),new a.Setting(r).setName("Focus Projects folder after archive").setDesc("Return focus to the Projects folder in the file explorer after archiving").addToggle(e=>e.setValue(this.plugin.settings.focusAfterArchive).onChange(async t=>{this.plugin.settings.focusAfterArchive=t,await this.plugin.saveSettings()})),new a.Setting(r).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(e=>e.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async t=>{this.plugin.settings.confirmBeforeArchive=t,await this.plugin.saveSettings()}))}};function d(c){return c.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function $(c){let r=d(c),e=r.lastIndexOf("/");return e===-1?"":r.substring(0,e)}function P(c,r){let e=d(c),t=d(r);return $(e)===t}function y(c){let r=d(c),e=r.lastIndexOf("/");return e===-1?r:r.substring(e+1)}function m(c,r,e){let t=d(c),s=`${t}/${r}`;if(!e.has(s))return s;let i=new Date().toISOString().split("T")[0],u=`${t}/${r} (Archived ${i})`;if(!e.has(u))return u;let h=2;for(;;){let g=`${t}/${r} (Archived ${i}) (${h})`;if(!e.has(g))return g;if(h++,h>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var j=3,A=class extends n.Modal{constructor(e,t,s,o,i){super(e);this.confirmed=!1;this.folderName=t,this.destPath=s,this.onConfirm=o,this.onCancel=i}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Project?"}),e.createEl("p",{text:`Move "${this.folderName}" to:`}),e.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let o=t.createEl("button",{text:"Archive",cls:"mod-cta"});o.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),o.focus(),this.keydownHandler=i=>{i.key==="Enter"&&!i.isComposing?(i.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):i.key==="Escape"&&(i.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},f=class extends n.Plugin{constructor(){super(...arguments);this.settings=l;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new p(this.app,this)),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof n.TFolder)&&!(t instanceof n.TFile)||!this.getSourceFolders().some(i=>P(t.path,i))||e.addItem(i=>{i.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}async loadSettings(){this.settings=Object.assign({},l,await this.loadData());let e=this.getSourceFolders(),t=(0,n.normalizePath)(this.settings.archivePath);if(e.includes(t)){new n.Notice("Archive Project: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=l.projectsPath,this.settings.areasPath=l.areasPath,this.settings.resourcesPath=l.resourcesPath,this.settings.archivePath=l.archivePath,await this.saveSettings();return}new Set(e).size!==e.length&&(new n.Notice("Archive Project: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=l.projectsPath,this.settings.areasPath=l.areasPath,this.settings.resourcesPath=l.resourcesPath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}getSourceFolders(){return[(0,n.normalizePath)(this.settings.projectsPath),(0,n.normalizePath)(this.settings.areasPath),(0,n.normalizePath)(this.settings.resourcesPath)]}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,n.normalizePath)(this.settings.archivePath),s=y(e.path);try{let i=this.getSourceFolders().find(g=>P(e.path,g));await this.ensureFolderExists(t);let u=this.getExistingArchivePaths(t),h=m(t,s,u);if(this.settings.confirmBeforeArchive)return new Promise(g=>{new A(this.app,s,h,async()=>{await this.performArchive(e,h,s,t,i),g()},()=>g()).open()});await this.performArchive(e,h,s,t,i)}catch(o){let i=o instanceof Error?o.message:"Unknown error";new n.Notice(`Failed to archive "${s}": ${i}`),console.error("Archive Project: Failed to archive item",o)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,s,o,i){let u=t;for(let h=0;h<j;h++)try{await this.app.vault.rename(e,t);break}catch(g){if(h===j-1)throw g;let w=this.getExistingArchivePaths(o);w.add(t),t=m(o,s,w)}t!==u?new n.Notice(`Archived "${s}" to ${t} (path changed due to conflict)`):new n.Notice(`Archived "${s}" to ${t}`),this.settings.focusAfterArchive&&i&&await this.focusSourceFolder(i)}async ensureFolderExists(e){let t=this.app.vault.getAbstractFileByPath(e);if(!t)await this.app.vault.createFolder(e);else if(!(t instanceof n.TFolder))throw new Error(`"${e}" exists but is not a folder`)}getExistingArchivePaths(e){let t=new Set,s=this.app.vault.getAbstractFileByPath(e);if(s instanceof n.TFolder)for(let o of s.children)t.add((0,n.normalizePath)(o.path));return t}async focusSourceFolder(e){let t=(0,n.normalizePath)(e),s=this.app.vault.getAbstractFileByPath(t);if(s)try{let o=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!o)return;let i=o.view;typeof i.revealInFolder=="function"&&i.revealInFolder(s)}catch(o){console.debug("Archive Project: Could not focus source folder",o)}}};
