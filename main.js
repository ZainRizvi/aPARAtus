"use strict";var E=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var z=(i,r)=>{for(var e in r)E(i,e,{get:r[e],enumerable:!0})},O=(i,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of M(r))!B.call(i,s)&&s!==e&&E(i,s,{get:()=>r[s],enumerable:!(t=R(r,s))||t.enumerable});return i};var _=i=>O(E({},"__esModule",{value:!0}),i);var H={};z(H,{default:()=>y});module.exports=_(H);var o=require("obsidian");var d=require("obsidian");function S(i,r){let e=u(i),t=u(r);return!!(e===t||t.startsWith(e+"/")||e.startsWith(t+"/"))}function j(i){for(let r=0;r<i.length;r++)for(let e=r+1;e<i.length;e++)if(S(i[r],i[e])){let t=u(i[r]),s=u(i[e]);return`PARA folders cannot be nested: "${t}" and "${s}"`}return null}function u(i){return i.replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function V(i){let r=u(i),e=r.lastIndexOf("/");return e===-1?"":r.substring(0,e)}function P(i,r){let e=u(i),t=u(r);return V(e)===t}function C(i){let r=u(i),e=r.lastIndexOf("/");return e===-1?r:r.substring(e+1)}function x(i,r,e){let t=u(i),s=`${t}/${r}`;if(!e.has(s))return s;let a=new Date().toISOString().split("T")[0],c=`${t}/${r} (Archived ${a})`;if(!e.has(c))return c;let l=2;for(;;){let p=`${t}/${r} (Archived ${a}) (${l})`;if(!e.has(p))return p;if(l++,l>1e3)throw new Error("Too many archive collisions - please clean up your archive folder")}}var h={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive",focusAfterArchive:!0,confirmBeforeArchive:!1},k={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"},L={projectsPath:"Projects",areasPath:"Areas",resourcesPath:"Resources",archivePath:"Archive"};function U(i,r,e){let s=["projectsPath","areasPath","resourcesPath","archivePath"].filter(n=>n!==r);for(let n of s){let a=e[n],c=k[n],l=k[r];if(i===a)return`${l} folder cannot be the same as ${c} folder`;if(S(i,a))return`${l} folder cannot be nested with ${c} folder`}return null}var T="para-manager-invalid-input";function A(i,r,e){let t=i.inputEl;i.setPlaceholder(L[r]).setValue(e.settings[r]),t.addEventListener("blur",async()=>{let n=i.getValue().trim().replace(/\/+$/,"")||L[r],a=U(n,r,e.settings);a?(t.classList.add(T),t.style.borderColor="var(--text-error)",t.style.backgroundColor="rgba(var(--color-red-rgb), 0.1)",new d.Notice(a),i.setValue(e.settings[r]),setTimeout(()=>{t.classList.remove(T),t.style.borderColor="",t.style.backgroundColor=""},100)):(t.classList.remove(T),t.style.borderColor="",t.style.backgroundColor="",e.settings[r]=n,await e.saveSettings())})}var w=class extends d.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),new d.Setting(r).setName("Projects folder").setDesc("Path to your Projects folder (top-level project folders live here)").addText(e=>A(e,"projectsPath",this.plugin)),new d.Setting(r).setName("Areas folder").setDesc("Path to your Areas folder (top-level area folders live here)").addText(e=>A(e,"areasPath",this.plugin)),new d.Setting(r).setName("Resources folder").setDesc("Path to your Resources folder (top-level resource folders live here)").addText(e=>A(e,"resourcesPath",this.plugin)),new d.Setting(r).setName("Archive folder").setDesc("Path where archived items will be moved").addText(e=>A(e,"archivePath",this.plugin)),new d.Setting(r).setName("Focus source folder after archive").setDesc("Return focus to the source folder (Projects, Areas, or Resources) after archiving").addToggle(e=>e.setValue(this.plugin.settings.focusAfterArchive).onChange(async t=>{this.plugin.settings.focusAfterArchive=t,await this.plugin.saveSettings()})),new d.Setting(r).setName("Confirm before archiving").setDesc("Show a confirmation dialog before archiving a project").addToggle(e=>e.setValue(this.plugin.settings.confirmBeforeArchive).onChange(async t=>{this.plugin.settings.confirmBeforeArchive=t,await this.plugin.saveSettings()}))}};var $=require("obsidian"),F=class extends $.Modal{constructor(e,t,s,n,a){super(e);this.confirmed=!1;this.itemName=t,this.destPath=s,this.onConfirm=n,this.onCancel=a}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Archive Item?"}),e.createEl("p",{text:`Move "${this.itemName}" to:`}),e.createEl("p",{text:this.destPath,cls:"archive-dest-path"});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let n=t.createEl("button",{text:"Archive",cls:"mod-cta"});n.addEventListener("click",()=>{this.confirmed=!0,this.onConfirm(),this.close()}),n.focus(),this.keydownHandler=a=>{a.key==="Enter"&&!a.isComposing?(a.preventDefault(),this.confirmed=!0,this.onConfirm(),this.close()):a.key==="Escape"&&(a.preventDefault(),this.close())},e.addEventListener("keydown",this.keydownHandler)}onClose(){let{contentEl:e}=this;this.keydownHandler&&e.removeEventListener("keydown",this.keydownHandler),e.empty(),this.confirmed||this.onCancel()}},v=class extends $.Modal{constructor(r,e,t,s){super(r),this.title=e,this.placeholder=t,this.onSubmit=s}onOpen(){let{contentEl:r}=this;r.createEl("h2",{text:this.title});let e=r.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.style.marginBottom="1em",e.focus();let t=r.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Create",cls:"mod-cta"}).addEventListener("click",()=>{let a=e.value.trim();a&&(this.onSubmit(a),this.close())}),e.addEventListener("keydown",a=>{if(a.key==="Enter"&&!a.isComposing){a.preventDefault();let c=e.value.trim();c&&(this.onSubmit(c),this.close())}else a.key==="Escape"&&(a.preventDefault(),this.close())})}onClose(){let{contentEl:r}=this;r.empty()}};var g=require("obsidian");async function b(i,r){let e=(0,g.normalizePath)(r),t=i.vault.getAbstractFileByPath(e);if(t){if(!(t instanceof g.TFolder))throw new Error(`"${e}" exists but is not a folder`);return}let s=e.split("/").filter(Boolean);for(let n=1;n<=s.length;n++){let a=s.slice(0,n).join("/"),c=i.vault.getAbstractFileByPath(a);if(!c)await i.vault.createFolder(a);else if(!(c instanceof g.TFolder))throw new Error(`Cannot create folder "${e}": intermediate path "${a}" exists but is not a folder`)}}function I(i,r){let e=new Set,t=i.vault.getAbstractFileByPath(r);if(t instanceof g.TFolder)for(let s of t.children)e.add((0,g.normalizePath)(s.path));return e}async function D(i,r){let e=(0,g.normalizePath)(r),t=i.vault.getAbstractFileByPath(e);if(t)try{let s=i.workspace.getLeavesOfType("file-explorer")[0];if(!s)return;let n=s.view;typeof n.revealInFolder=="function"&&n.revealInFolder(t)}catch(s){console.debug("PARA Manager: Could not focus folder",s)}}var N=3,y=class extends o.Plugin{constructor(){super(...arguments);this.settings=h;this.archivingItems=new Set}async onload(){await this.loadSettings(),this.addSettingTab(new w(this.app,this)),this.addCommand({id:"archive-item",name:"Archive Item",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let s=this.findTopLevelItem(t);return s?(e||this.archiveItem(s),!0):!1}}),this.addCommand({id:"create-project",name:"Create Project",callback:()=>{new v(this.app,"Create Project","Project name",e=>this.createParaItem(e,"projectsPath","Project")).open()}}),this.addCommand({id:"create-area",name:"Create Area",callback:()=>{new v(this.app,"Create Area","Area name",e=>this.createParaItem(e,"areasPath","Area")).open()}}),this.addCommand({id:"create-resource",name:"Create Resource",callback:()=>{new v(this.app,"Create Resource","Resource name",e=>this.createParaItem(e,"resourcesPath","Resource")).open()}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof o.TFolder)&&!(t instanceof o.TFile)||!this.getSourceFolders().some(a=>P(t.path,a))||e.addItem(a=>{a.setTitle("Archive it").setIcon("archive").onClick(async()=>{await this.archiveItem(t)})})}))}async loadSettings(){this.settings=Object.assign({},h,await this.loadData());let e=this.getSourceFolders(),t=(0,o.normalizePath)(this.settings.archivePath);if(e.includes(t)){new o.Notice("PARA Manager: Invalid settings detected (archive matches source folder), resetting to defaults"),this.settings.projectsPath=h.projectsPath,this.settings.areasPath=h.areasPath,this.settings.resourcesPath=h.resourcesPath,this.settings.archivePath=h.archivePath,await this.saveSettings();return}if(new Set(e).size!==e.length){new o.Notice("PARA Manager: Invalid settings detected (source folders match), resetting to defaults"),this.settings.projectsPath=h.projectsPath,this.settings.areasPath=h.areasPath,this.settings.resourcesPath=h.resourcesPath,await this.saveSettings();return}let n=[this.settings.projectsPath,this.settings.areasPath,this.settings.resourcesPath,this.settings.archivePath],a=j(n);a&&(new o.Notice(`PARA Manager: Invalid settings detected (${a}), resetting to defaults`),this.settings.projectsPath=h.projectsPath,this.settings.areasPath=h.areasPath,this.settings.resourcesPath=h.resourcesPath,this.settings.archivePath=h.archivePath,await this.saveSettings())}async saveSettings(){await this.saveData(this.settings)}async createParaItem(e,t,s){let n=this.settings[t],a=(0,o.normalizePath)(`${n}/${e}`);if(this.app.vault.getAbstractFileByPath(a)){new o.Notice(`${s} "${e}" already exists`);return}try{await b(this.app,n),await this.app.vault.createFolder(a);let c=(0,o.normalizePath)(`${a}/index.md`),l=`# ${e}
`,p=await this.app.vault.create(c,l);await this.app.workspace.getLeaf().openFile(p),new o.Notice(`Created ${s.toLowerCase()} "${e}"`)}catch(c){let l=c instanceof Error?c.message:"Unknown error";new o.Notice(`Failed to create ${s.toLowerCase()}: ${l}`),console.error(`PARA Manager: Failed to create ${s}`,c)}}getSourceFolders(){return[(0,o.normalizePath)(this.settings.projectsPath),(0,o.normalizePath)(this.settings.areasPath),(0,o.normalizePath)(this.settings.resourcesPath)]}findTopLevelItem(e){let t=this.getSourceFolders();if(t.some(n=>P(e.path,n)))return e;let s=e.parent;for(;s;){if(t.some(n=>P(s.path,n)))return s;s=s.parent}return null}async archiveItem(e){if(this.archivingItems.has(e.path))return;this.archivingItems.add(e.path);let t=(0,o.normalizePath)(this.settings.archivePath),s=C(e.path);try{let a=this.getSourceFolders().find(m=>P(e.path,m)),c=a?C(a):"";await b(this.app,t);let l=c?(0,o.normalizePath)(`${t}/${c}`):t;await b(this.app,l);let p=I(this.app,l),f=x(l,s,p);if(this.settings.confirmBeforeArchive)return new Promise(m=>{new F(this.app,s,f,async()=>{await this.performArchive(e,f,s,l,a),m()},()=>m()).open()});await this.performArchive(e,f,s,l,a)}catch(n){let a=n instanceof Error?n.message:"Unknown error";new o.Notice(`Failed to archive "${s}": ${a}`),console.error("PARA Manager: Failed to archive item",n)}finally{this.archivingItems.delete(e.path)}}async performArchive(e,t,s,n,a){let c=t;for(let l=0;l<N;l++)try{await this.app.vault.rename(e,t);break}catch(p){if(l===N-1)throw p;let f=I(this.app,n);f.add(t),t=x(n,s,f)}t!==c?new o.Notice(`Archived "${s}" to ${t} (path changed due to conflict)`):new o.Notice(`Archived "${s}" to ${t}`),this.settings.focusAfterArchive&&a&&await D(this.app,a)}};
